```yaml
name: Build
on:
  push:
    branches: [ main ]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: 3.19.0

      - name: Write pubspec
        run: |
          printf '%s\n' \
            'name: mic_app' \
            'environment:' \
            '  sdk: ">=3.0.0 <4.0.0"' \
            '  flutter: ">=3.19.0"' \
            'dependencies:' \
            '  flutter:' \
            '    sdk: flutter' \
            '  camera: ^0.11.0' \
            '  tflite_v2: ^1.0.0' \
            'flutter:' \
            '  uses-material-design: true' \
            '  assets:' \
            '    - assets/labels.txt' \
            '    - assets/model.tflite' \
            > pubspec.yaml

      - name: Prep & Deep Fix
        run: |
          rm -rf android
          flutter create --platforms android --project-name mic_app .

          python3 - << 'PYEOF'
import re

with open('android/app/build.gradle', 'r') as f:
    content = f.read()

content = re.sub(r'minSdk\s*=\s*\S+', 'minSdk = 21', content)

packaging = '\n    packagingOptions {\n        resources {\n            noCompress += [".tflite"]\n        }\n    }'
content = re.sub(r'(android\s*\{)', r'\1' + packaging, content, count=1)

ndk = '\n        ndk { abiFilters "armeabi-v7a", "arm64-v8a" }'
content = re.sub(r'(defaultConfig\s*\{)', r'\1' + ndk, content, count=1)

with open('android/app/build.gradle', 'w') as f:
    f.write(content)

with open('android/app/src/main/AndroidManifest.xml', 'r') as f:
    content = f.read()

permissions = '    <uses-permission android:name="android.permission.CAMERA" />\n    <uses-feature android:name="android.hardware.camera" />\n'
content = content.replace('<application', permissions + '    <application', 1)

with open('android/app/src/main/AndroidManifest.xml', 'w') as f:
    f.write(content)
PYEOF

      - name: Check Assets
        run: |
          if [ ! -f "assets/model.tflite" ]; then echo "ERRORE: assets/model.tflite mancante!"; exit 1; fi
          if [ ! -f "assets/labels.txt" ]; then echo "ERRORE: assets/labels.txt mancante!"; exit 1; fi
          echo "Asset check OK"

      - name: Build APK
        run: |
          flutter clean
          flutter pub get
          flutter build apk --release --no-tree-shake-icons

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: build/app/outputs/flutter-apk/app-release.apk
```
